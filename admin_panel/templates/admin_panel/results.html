{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Résultats" %} - {{ date_group.title }} - {% trans "Panneau d'administration" %}{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-6 space-y-3 sm:space-y-0">
        <div class="flex-1">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">{% trans "Résultats du vote" %}: {{ date_group.title }}</h1>
            {% if date_group.description %}
                <p class="text-gray-600 mt-2 text-sm sm:text-base">{{ date_group.description }}</p>
            {% endif %}
        </div>
    </div>

    {% if statistics %}
    <div class="mb-4">
        <button type="button" id="toggle-children-column" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition duration-200 text-sm sm:text-base">
            {% trans "Afficher le détail" %}
        </button>
        <a href="{% url 'admin_panel:export_excel' date_group.pk %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-200 text-sm sm:text-base whitespace-nowrap">
            {% trans "Exporter Excel" %}
        </a>
    </div>
    
    <!-- Summary Table -->
    <div class="mb-6">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">{% trans "Résumé des votes" %}</h2>
        <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300">{% trans "Date" %}</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-50 border-r border-gray-300">{% trans "Matin" %}</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-50 border-r border-gray-300">{% trans "Repas" %}</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-50">{% trans "Après-midi" %}</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% regroup statistics by option as date_stats %}
                    {% for date_option in date_stats %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-300">
                                {{ date_option.grouper.date|date:"l j F Y" }}
                            </td>
                            {% for stat in date_option.list %}
                                {% if stat.time_slot.period == 'morning' %}
                                    <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-semibold text-green-700 border-r border-gray-300 summary-yes-count" data-date-option-id="{{ date_option.grouper.id }}" data-period="morning">
                                        {{ stat.yes }}
                                    </td>
                                {% endif %}
                            {% endfor %}
                            {% for stat in date_option.list %}
                                {% if stat.time_slot.period == 'lunch' %}
                                    <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-semibold text-green-700 border-r border-gray-300 summary-yes-count" data-date-option-id="{{ date_option.grouper.id }}" data-period="lunch">
                                        {{ stat.yes }}
                                    </td>
                                {% endif %}
                            {% endfor %}
                            {% for stat in date_option.list %}
                                {% if stat.time_slot.period == 'afternoon' %}
                                    <td class="px-4 py-3 whitespace-nowrap text-center text-sm font-semibold text-green-700 summary-yes-count" data-date-option-id="{{ date_option.grouper.id }}" data-period="afternoon">
                                        {{ stat.yes }}
                                    </td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="space-y-4 sm:space-y-6">
        {% regroup statistics by option as date_stats %}
        {% for date_option in date_stats %}
            <div class="border border-gray-300 rounded-lg p-3 sm:p-4 bg-white">
                <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">{{ date_option.grouper.date|date:"l j F Y" }}</h3>
                <div class="overflow-x-auto -mx-3 sm:mx-0">
                    <table class="min-w-full divide-y divide-gray-200 text-xs sm:text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{% trans "Période" %}</th>
                                <th class="ml-2 bg-green-100 text-green-800 px-2 sm:px-3 py-1 rounded hover:bg-green-200 transition text-xs sm:text-sm">{% trans "Oui" %}</th>
                                <th class="ml-2 bg-red-100 text-red-800 px-2 sm:px-3 py-1 rounded hover:bg-red-200 transition text-xs sm:text-sm">{% trans "Non" %}</th>
                                <th class="children-column hidden ml-2 bg-gray-100 text-gray-800 px-2 sm:px-3 py-1 rounded hover:bg-gray-200 transition text-xs sm:text-sm">{% trans "Enfants" %}</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for stat in date_option.list|dictsortreversed:"time_slot.period" %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                        {{ stat.time_slot.get_period_display }}
                                    </td>
                                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-center detail-yes-count" data-date-option-id="{{ stat.time_slot.date_option.id }}" data-period="{{ stat.time_slot.period }}">
                                        <span class="text-sm font-medium text-green-700">{{ stat.yes }}</span>
                                    </td>
                                    <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-center detail-no-count" data-date-option-id="{{ stat.time_slot.date_option.id }}" data-period="{{ stat.time_slot.period }}">
                                        <span class="text-sm font-medium text-red-700">{{ stat.no }}</span>
                                    </td>
                                    <td class="children-column hidden px-3 sm:px-6 py-4 text-sm text-gray-600" data-date-option-id="{{ stat.time_slot.date_option.id }}" data-period="{{ stat.time_slot.period }}">
                                        <div class="flex flex-col space-y-2">
                                            <div>
                                                <span class="font-medium text-green-700 block mb-1">{% trans "Oui" %}:</span>
                                                <ul class="space-y-1 yes-list">
                                                    {% for vote in stat.yes_votes %}
                                                        <li class="flex items-center justify-between vote-item" data-vote-id="{{ vote.id }}" data-choice="yes">
                                                            <span>{{ vote.child }}</span>
                                                            <button type="button"
                                                                    class="ml-2 text-gray-500 hover:text-gray-800 vote-toggle-btn"
                                                                    data-toggle-url="{% url 'admin_panel:toggle_vote' vote.id %}"
                                                                    title="{% trans 'Basculer' %}">
                                                                <span class="text-lg leading-none">✖</span>
                                                            </button>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            <div class="mt-2">
                                                <span class="font-medium text-red-700 block mb-1">{% trans "Non" %}:</span>
                                                <ul class="space-y-1 no-list">
                                                    {% for vote in stat.no_votes %}
                                                        <li class="flex items-center justify-between vote-item" data-vote-id="{{ vote.id }}" data-choice="no">
                                                            <span>{{ vote.child }}</span>
                                                            <button type="button"
                                                                    class="ml-2 text-gray-500 hover:text-gray-800 vote-toggle-btn"
                                                                    data-toggle-url="{% url 'admin_panel:toggle_vote' vote.id %}"
                                                                    title="{% trans 'Basculer' %}">
                                                                <span class="text-lg leading-none">✖</span>
                                                            </button>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-12">
        <p class="text-gray-600 text-lg">{% trans "Aucun vote n'a encore été exprimé pour ce groupe de dates." %}</p>
    </div>
{% endif %}


    <div class="mt-6">
        <a href="{% url 'admin_panel:dashboard' %}" class="bg-gray-500 text-white px-4 sm:px-6 py-2 rounded hover:bg-gray-600 transition duration-200 text-sm sm:text-base inline-block w-full sm:w-auto text-center">
            {% trans "Retour au tableau de bord" %}
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggle-children-column');
    const childrenColumns = document.querySelectorAll('.children-column');
    let isVisible = false;

    const showText = '{% trans "Afficher le détail" %}';
    const hideText = '{% trans "Masquer le détail" %}';

    if (toggleButton) {
        toggleButton.addEventListener('click', function() {
            isVisible = !isVisible;
            childrenColumns.forEach(function(column) {
                if (isVisible) {
                    column.classList.remove('hidden');
                } else {
                    column.classList.add('hidden');
                }
            });
            toggleButton.textContent = isVisible ? hideText : showText;
        });
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    const csrftoken = getCookie('csrftoken');

    document.querySelectorAll('.vote-toggle-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const url = button.getAttribute('data-toggle-url');
            const li = button.closest('.vote-item');
            const previousChoice = li.getAttribute('data-choice'); // 'yes' or 'no'
            const parentContainer = li.closest('.children-column');
            const yesList = parentContainer.querySelector('.yes-list');
            const noList = parentContainer.querySelector('.no-list');
            const dateOptionId = parentContainer.getAttribute('data-date-option-id');
            const period = parentContainer.getAttribute('data-period');

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(function(data) {
                if (data.status === 'ok') {
                    const newChoice = data.new_choice;

                    // Determine delta for yes-counts
                    let delta = 0;
                    if (previousChoice === 'yes' && newChoice === 'no') {
                        delta = -1;
                    } else if (previousChoice === 'no' && newChoice === 'yes') {
                        delta = 1;
                    }

                    // Update summary yes count
                    if (delta !== 0 && dateOptionId && period) {
                        const summaryCell = document.querySelector(
                            '.summary-yes-count[data-date-option-id="' +
                            dateOptionId +
                            '"][data-period="' +
                            period +
                            '"]'
                        );
                        if (summaryCell) {
                            const current = parseInt(summaryCell.textContent || '0', 10) || 0;
                            summaryCell.textContent = Math.max(current + delta, 0);
                        }

                        // Update detail yes/no counts for this row
                        const row = parentContainer.parentElement;
                        const detailYesCell = row.querySelector(
                            '.detail-yes-count[data-date-option-id="' +
                            dateOptionId +
                            '"][data-period="' +
                            period +
                            '"]'
                        );
                        const detailNoCell = row.querySelector(
                            '.detail-no-count[data-date-option-id="' +
                            dateOptionId +
                            '"][data-period="' +
                            period +
                            '"]'
                        );
                        if (detailYesCell) {
                            const span = detailYesCell.querySelector('span');
                            const currentYes = parseInt((span && span.textContent) || '0', 10) || 0;
                            span.textContent = Math.max(currentYes + delta, 0);
                        }
                        if (detailNoCell) {
                            const span = detailNoCell.querySelector('span');
                            const currentNo = parseInt((span && span.textContent) || '0', 10) || 0;
                            // No count moves opposite to yes
                            span.textContent = Math.max(currentNo - delta, 0);
                        }
                    }

                    // Move the item between lists without reloading the page
                    if (newChoice === 'yes' && yesList) {
                        li.setAttribute('data-choice', 'yes');
                        yesList.appendChild(li);
                    } else if (newChoice === 'no' && noList) {
                        li.setAttribute('data-choice', 'no');
                        noList.appendChild(li);
                    }
                }
            })
            .catch(function(error) {
                console.error('Error toggling vote:', error);
            });
        });
    });
});
</script>
{% endblock %}
